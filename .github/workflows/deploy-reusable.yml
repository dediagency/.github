name: Deploy Application

on:
  workflow_call:
    inputs:
      # Infrastructure (required)
      ssh_host:
        description: 'SSH host for deployment'
        required: true
        type: string
      ssh_username:
        description: 'SSH username'
        required: true
        type: string

      # Environment (required)
      environment:
        description: 'Environment name (recette, preproduction, production)'
        required: true
        type: string
      branch:
        description: 'Git branch to deploy'
        required: true
        type: string

      # Optional overrides
      site_url:
        description: 'Site URL (auto-generated if not provided)'
        required: false
        type: string
      deploy_path:
        description: 'Deploy path (auto-generated if not provided)'
        required: false
        type: string

      # Platform configuration
      platform:
        description: 'Platform type (sylius, wordpress, symfony)'
        required: false
        type: string
        default: 'sylius'
      php_version:
        description: 'PHP version to use'
        required: false
        type: string
        default: '8.3'

      # Permissions
      permission_method:
        description: 'Permission method (chmod or setfacl)'
        required: false
        type: string
        default: 'chmod'
      setfacl_user:
        description: 'User for setfacl permissions'
        required: false
        type: string
      setfacl_group:
        description: 'Group for setfacl permissions'
        required: false
        type: string

      # Custom commands (JSON arrays)
      db_operations:
        description: 'Database operations to run (JSON array)'
        required: false
        type: string
      cache_commands:
        description: 'Cache commands to run (JSON array)'
        required: false
        type: string
      asset_commands:
        description: 'Asset commands to run (JSON array)'
        required: false
        type: string
      post_deploy_commands:
        description: 'Post-deploy commands to run (JSON array)'
        required: false
        type: string

    secrets:
      ssh_private_key:
        description: 'SSH private key for deployment'
        required: false  # Optional car d√©faut dans l'action

    outputs:
      deployment_url:
        description: "URL of the deployed application"
        value: ${{ jobs.deploy.outputs.deployment_url }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ inputs.site_url || format('https://{0}-{1}.dediagency.dev', inputs.environment, inputs.ssh_username) }}

    outputs:
      deployment_url: ${{ inputs.site_url || format('https://{0}-{1}.dediagency.dev', inputs.environment, inputs.ssh_username) }}

    steps:
      - name: Deploy to ${{ inputs.environment }}
        uses: dediagency/.github/actions/deploy@v0
        with:
          # Infrastructure
          ssh_host: ${{ inputs.ssh_host }}
          ssh_username: ${{ inputs.ssh_username }}
          ssh_private_key: ${{ secrets.ssh_private_key }}

          # Environment
          environment: ${{ inputs.environment }}
          branch: ${{ inputs.branch }}
          site_url: ${{ inputs.site_url }}
          deploy_path: ${{ inputs.deploy_path }}

          # Platform
          platform: ${{ inputs.platform }}
          php_version: ${{ inputs.php_version }}

          # Permissions
          permission_method: ${{ inputs.permission_method }}
          setfacl_user: ${{ inputs.setfacl_user }}
          setfacl_group: ${{ inputs.setfacl_group }}

          # Custom commands
          db_operations: ${{ inputs.db_operations }}
          cache_commands: ${{ inputs.cache_commands }}
          asset_commands: ${{ inputs.asset_commands }}
          post_deploy_commands: ${{ inputs.post_deploy_commands }}